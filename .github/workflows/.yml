name: üöÄ LongVPS 

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      # BANNER CH√ÄO M·ª™NG
  shell: pwsh
  run: |
    $banner = @"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë              üöÄ LONGDAY SERVER               ‚ïë
‚ïë         ‚ö° Powered by AIL | Premium RDP       ‚ïë
‚ïë----------------------------------------------‚ïë
‚ïë  üïí Th·ªùi gian:  ${{ github.event.inputs.duration }}             
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"@

    Write-Output $banner

    $frames = @('‚£æ','‚£Ω','‚£ª','‚¢ø','‚°ø','‚£ü','‚£Ø','‚£∑')
    for($i=0; $i -lt 20; $i++){
      Write-Host "`rüöÄ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng... $($frames[$i%8])" -NoNewline
      Start-Sleep -Milliseconds 80
    }
    Write-Host "`r‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!      "

      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ü§ñ Longday SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AIL" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          
          # Hi·ªáu ·ª©ng loading
          $frames = @('‚£æ', '‚£Ω', '‚£ª', '‚¢ø', '‚°ø', '‚£ü', '‚£Ø', '‚£∑')
          for($i=0; $i -lt 10; $i++) {
              Write-Host "`rüöÄ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!                    " -ForegroundColor Green

      # C·∫§U H√åNH N√ÇNG CAO
      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host "üõ†Ô∏è  ƒêANG C·∫§U H√åNH H·ªÜ TH·ªêNG" -ForegroundColor Yellow
          
          $steps = @(
              @{Name="B·∫≠t Remote Desktop"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="T·∫Øt x√°c th·ª±c m·∫°ng"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="C·∫•u h√¨nh b·∫£o m·∫≠t RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="M·ªü port 3389 firewall"; Script={
                  netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
                  netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
              }},
              @{Name="Kh·ªüi ƒë·ªông d·ªãch v·ª•"; Script={
                  Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                  Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "‚îÇ üìã $($step.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - ƒê√£ b·ªè qua l·ªói nh·ªè" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 500
          }
          
          Write-Host "üéØ C·∫•u h√¨nh ho√†n t·∫•t!" -ForegroundColor Green

      # T·∫†O USER PREMIUM
      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          Write-Host ""
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N PREMIUM" -ForegroundColor Yellow
          
          function New-PremiumPassword {
              param()
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'
              $all = $upper + $lower + $numbers

              $pw = ''
              $pw += $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]

              for ($i = 1; $i -le 5; $i++) {
                  $pw += $all[(Get-Random -Minimum 0 -Maximum $all.Length)]
              }

              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }

          if ($env:CUSTOM_RDP_PASS) {
              $matKhau = $env:CUSTOM_RDP_PASS
              Write-Host "‚îÇ ‚ÑπÔ∏è  D√πng m·∫≠t kh·∫©u t√πy ch·ªânh t·ª´ env" -ForegroundColor Blue
          } else {
              $matKhau = New-PremiumPassword
          }

          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          
          try {
              Remove-LocalUser -Name "LongDay2203" -ErrorAction SilentlyContinue
              Write-Host "‚îÇ ‚úÖ ƒê√£ x√≥a user c≈©" -ForegroundColor Green
          } catch {}

          try {
              New-LocalUser -Name "LongDay2203" -Password $securePass -AccountNeverExpires -Description "LongDay Premium User"
              Enable-LocalUser -Name "LongDay2203"
              Add-LocalGroupMember -Group "Administrators" -Member "LongDay2203"
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "LongDay2203"
              Write-Host "‚îÇ ‚úÖ ƒê√£ t·∫°o user + c·∫•p quy·ªÅn" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ùå L·ªói t·∫°o user: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
          }

          echo "RDP_USER=LongDay2203" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          
          Write-Host "‚úÖ T√†i kho·∫£n LongDay2203 ƒë√£ s·∫µn s√†ng" -ForegroundColor Green

      # KI·ªÇM TRA QUY·ªÄN
      - name: üîç KI·ªÇM TRA QUY·ªÄN H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host "üîç KI·ªÇM TRA QUY·ªÄN ƒêƒÇNG NH·∫¨P" -ForegroundColor Yellow
          
          $user = Get-LocalUser -Name "LongDay2203" -ErrorAction SilentlyContinue
          if ($user) {
              Write-Host "‚îÇ ‚úÖ User LongDay2203 t·ªìn t·∫°i" -ForegroundColor Green
          } else {
              Write-Host "‚îÇ ‚ùå User kh√¥ng t·ªìn t·∫°i" -ForegroundColor Red
              exit 1
          }

          $isAdmin = (Get-LocalGroupMember -Group "Administrators" | Where-Object {$_.Name -like "*LongDay2203"}).Count -gt 0
          if ($isAdmin) { Write-Host "‚îÇ ‚úÖ C√≥ quy·ªÅn Administrator" -ForegroundColor Green }

          $isRDPUser = (Get-LocalGroupMember -Group "Remote Desktop Users" | Where-Object {$_.Name -like "*LongDay2203"}).Count -gt 0
          if ($isRDPUser) { Write-Host "‚îÇ ‚úÖ C√≥ quy·ªÅn Remote Desktop" -ForegroundColor Green }

          $termService = Get-Service -Name TermService
          if ($termService.Status -eq 'Running') {
              Write-Host "‚îÇ ‚úÖ D·ªãch v·ª• TermService ƒëang ch·∫°y" -ForegroundColor Green
          }

          Write-Host "üéØ Ki·ªÉm tra ho√†n t·∫•t!" -ForegroundColor Green

      # TAILSCALE
      - name: üåê THI·∫æT L·∫¨P M·∫†NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "üåê ƒêANG THI·∫æT L·∫¨P K·∫æT N·ªêI M·∫†NG" -ForegroundColor Yellow
          
          try {
              $msiPath = "$env:TEMP\tailscale-premium.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $msiPath -Force
              Write-Host "‚îÇ ‚úÖ C√†i ƒë·∫∑t Tailscale th√†nh c√¥ng" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ùå L·ªói c√†i ƒë·∫∑t Tailscale" -ForegroundColor Red
          }
          
          Start-Sleep -Seconds 8

          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=LongDay-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
              Write-Host "‚îÇ ‚úÖ K·∫øt n·ªëi Tailscale th√†nh c√¥ng" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ùå L·ªói k·∫øt n·ªëi Tailscale" -ForegroundColor Red
          }

          # L·∫•y IP
          $ip = $null
          for($i=0; $i -lt 20; $i++) {
              try {
                  $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                  if ($ip -match '^\d+\.\d+\.\d+\.\d+$') {
                      echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                      Write-Host "‚îÇ ‚úÖ ƒê·ªãa ch·ªâ IP: $ip" -ForegroundColor Green
                      break
                  }
              } catch {}
              Start-Sleep -Seconds 3
          }

          if (-not $ip) {
              echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
              Write-Host "‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y IP Tailscale" -ForegroundColor Yellow
          }

      # TH√îNG TIN K·∫æT N·ªêI
      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "1h" { $totalMinutes = 60; $displayTime = "1 gi·ªù" }
              "3h" { $totalMinutes = 180; $displayTime = "3 gi·ªù" }
              "5h40m" { $totalMinutes = 340; $displayTime = "5 gi·ªù 40 ph√∫t" }
          }

          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $start = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $end = $start.AddMinutes($totalMinutes)

          Write-Host ""
          Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ              üéâ K·∫æT N·ªêI TH√ÄNH C√îNG!              ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üåê  ƒê·ªãa ch·ªâ: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "‚îÇ üë§  T√†i kho·∫£n: LongDay2203" -ForegroundColor White
          Write-Host "‚îÇ üîê  M·∫≠t kh·∫©u: $matKhau" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞  Th·ªùi l∆∞·ª£ng: $displayTime" -ForegroundColor White
          Write-Host "‚îÇ üïê  B·∫Øt ƒë·∫ßu: $($start.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "‚îÇ üïê  K·∫øt th√∫c: $($end.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "‚îÇ üìç  Port: 3389" -ForegroundColor White
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üí°  H∆∞·ªõng d·∫´n:                                    ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îÇ   1. M·ªü Remote Desktop Connection                 ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   2. Nh·∫≠p: $env:TAILSCALE_IP                      ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   3. User: LongDay2203 | Pass: ph√≠a tr√™n          ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   4. Enjoy! üöÄ                                    ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan

          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      # DUY TR√å PHI√äN
      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          $totalMinutes = [int]$env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")

          $start = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $end = $start.AddMinutes($totalMinutes)

          Write-Host ""
          Write-Host "üîÑ B·∫ÆT ƒê·∫¶U DUY TR√å PHI√äN..." -ForegroundColor Yellow
          Write-Host "üîó K·∫øt n·ªëi: $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "üïê B·∫Øt ƒë·∫ßu: $($start.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host "üïê K·∫øt th√∫c: $($end.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host ""

          do {
              $now = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $remain = $end - $now

              $h = [math]::Max(0, [math]::Floor($remain.TotalHours))
              $m = [math]::Max(0, [math]::Floor($remain.TotalMinutes % 60))
              $s = [math]::Max(0, [math]::Floor($remain.TotalSeconds % 60))

              Write-Host "`r‚è≥ Th·ªùi gian c√≤n l·∫°i: $h gi·ªù $m ph√∫t $s gi√¢y" -NoNewline -ForegroundColor Cyan
              Start-Sleep -Seconds 5

          } while ($remain.TotalSeconds -gt 0)

          Write-Host ""
          Write-Host "üéØ H·∫æT TH·ªúI GIAN ‚Äî T·ª∞ ƒê·ªòNG D·ª™NG!" -ForegroundColor Red

      # D·ªåN D·∫∏P
      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          Write-Host ""
          Write-Host "üßπ ƒêANG D·ªåN D·∫∏P H·ªÜ TH·ªêNG..." -ForegroundColor Yellow
          
          $steps = @(
              @{Name="X√≥a file password"; Script={
                  Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
              }},
              @{Name="V√¥ hi·ªáu h√≥a user"; Script={
                  Disable-LocalUser -Name "LongDay2203" -ErrorAction SilentlyContinue
              }},
              @{Name="ƒê√≥ng k·∫øt n·ªëi Tailscale"; Script={
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
              }},
              @{Name="X√≥a rule firewall"; Script={
                  netsh advfirewall firewall delete rule name="RDP-Premium" -ErrorAction SilentlyContinue
                  netsh advfirewall firewall delete rule name="RDP-Premium-Out" -ErrorAction SilentlyContinue
              }},
              @{Name="Kh√¥i ph·ª•c RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
                  Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
              }}
          )

          foreach($step in $steps) {
              Write-Host "‚îÇ üóëÔ∏è  $($step.Name)..." -NoNewline -ForegroundColor Gray
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - ƒê√£ x·ª≠ l√Ω an to√†n" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 300
          }

          Write-Host ""
          Write-Host "üéâ D·ªåN D·∫∏P HO√ÄN T·∫§T! H·∫∏N G·∫∂P L·∫†I üëã" -ForegroundColor Green
